<div
  class="bg-neutral-950 border border-gray-800 rounded-lg h-full flex flex-col"
>
  <div class="border-b border-gray-800 p-6">
    <h3 class="text-lg font-semibold text-gray-100">Despesas por Categoria</h3>
  </div>

  <div class="p-6 flex-1">
    @if (isLoading()) {
    <div class="flex items-center justify-center h-full">
      <div class="w-48 h-48 rounded-full bg-gray-800 animate-pulse"></div>
    </div>
    } @else if (chartConfig().hasData) {
    <div class="flex flex-col lg:flex-row gap-6 h-full">
      <div
        class="flex-1 flex items-center justify-center min-h-[300px] lg:min-h-[400px]"
      >
        <div class="relative">
          <svg
            width="300"
            height="300"
            viewBox="0 0 300 300"
            class="w-full h-full max-w-[300px] max-h-[300px]"
          >
            @for (item of chartData(); track trackByName($index, item); let i =
            $index) { @let segmentAngles = getSegmentAngles()[i]; @if
            (segmentAngles) { @let path =
            getSegmentPath(segmentAngles.startAngle, segmentAngles.endAngle,
            chartConfig().radius, chartConfig().centerX, chartConfig().centerY);
            @let midAngle = (segmentAngles.startAngle + segmentAngles.endAngle)
            / 2; @let labelPos = getPointOnCircle(midAngle, chartConfig().radius
            + 20, chartConfig().centerX, chartConfig().centerY); @let isExternal
            = shouldLabelBeExternal(segmentAngles, i);

            <g
              class="transition-all duration-300 hover:scale-105 transform origin-center"
            >
              <path
                [attr.d]="path"
                [attr.fill]="item.color"
                stroke="#1f2937"
                stroke-width="2"
                class="cursor-pointer hover:opacity-80 transition-opacity"
              />

              @if (isExternal) {
              <text
                [attr.x]="labelPos.x"
                [attr.y]="labelPos.y"
                text-anchor="middle"
                dominant-baseline="middle"
                class="text-xs font-medium fill-gray-100 pointer-events-none"
              >
                {{ item.percentage.toFixed(0) }}%
              </text>
              }
            </g>
            } }

            <circle
              [attr.cx]="chartConfig().centerX"
              [attr.cy]="chartConfig().centerY"
              r="40"
              fill="#0a0a0a"
              stroke="#374151"
              stroke-width="1"
            />

            <text
              [attr.x]="chartConfig().centerX"
              [attr.y]="chartConfig().centerY - 8"
              text-anchor="middle"
              dominant-baseline="middle"
              class="text-sm font-semibold fill-gray-100"
            >
              Total
            </text>
            <text
              [attr.x]="chartConfig().centerX"
              [attr.y]="chartConfig().centerY + 12"
              text-anchor="middle"
              dominant-baseline="middle"
              class="text-xs fill-gray-300"
            >
              {{ formatCurrency(chartConfig().total) }}
            </text>
          </svg>
        </div>
      </div>

      <div
        class="lg:w-48 flex lg:flex-col justify-center lg:justify-start gap-3 overflow-auto"
      >
        @for (item of chartData(); track trackByName($index, item)) {
        <div
          class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-800/50 transition-colors min-w-0"
        >
          <div
            class="w-3 h-3 rounded-full shrink-0"
            [style.background]="item.color"
          ></div>
          <div class="min-w-0 flex-1">
            <p class="text-sm text-gray-100 truncate">{{ item.name }}</p>
            <p class="text-xs text-gray-400">
              {{ formatCurrency(item.value) }}
            </p>
          </div>
          <span class="text-xs text-gray-300 font-medium shrink-0">
            {{ item.percentage.toFixed(1) }}%
          </span>
        </div>
        }
      </div>
    </div>
    } @else {
    <div class="flex items-center justify-center h-[300px] text-gray-500">
      <p>Sem dados de despesas para exibir.</p>
    </div>
    }
  </div>
</div>
